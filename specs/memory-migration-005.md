# Specification: omega-memory/migrations/005_scheduled_tasks.sql

## Path

`backend/crates/omega-memory/migrations/005_scheduled_tasks.sql`

## Purpose

Creates the `scheduled_tasks` table for user-scheduled reminders and recurring tasks. When a user asks Omega to remind them or schedule something, the AI provider includes a `SCHEDULE:` marker in its response. The gateway extracts this marker and stores the task in this table. A background scheduler loop periodically checks for due tasks and delivers them via the appropriate channel.

This migration was introduced alongside Phase 4 scheduler and heartbeat features.

## Prerequisites

- Migration `001_init.sql` must have been applied (creates the base schema).
- No dependency on other tables -- `scheduled_tasks` is independent of `conversations`, `messages`, and `facts`.

---

## Schema Changes

### CREATE TABLE: `scheduled_tasks`

```sql
CREATE TABLE IF NOT EXISTS scheduled_tasks (
    id           TEXT PRIMARY KEY,
    channel      TEXT NOT NULL,
    sender_id    TEXT NOT NULL,
    reply_target TEXT NOT NULL,
    description  TEXT NOT NULL,
    due_at       TEXT NOT NULL,
    repeat       TEXT,
    status       TEXT NOT NULL DEFAULT 'pending',
    created_at   TEXT NOT NULL DEFAULT (datetime('now')),
    delivered_at TEXT
);
```

### Column Descriptions

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | `TEXT` | `PRIMARY KEY` | UUID v4 string, generated by `Store::create_task()`. |
| `channel` | `TEXT` | `NOT NULL` | Channel name for delivery (e.g., `"telegram"`, `"whatsapp"`). |
| `sender_id` | `TEXT` | `NOT NULL` | Platform-specific user identifier of the task creator. Used for ownership checks on cancellation and listing. |
| `reply_target` | `TEXT` | `NOT NULL` | Platform-specific delivery target (e.g., Telegram chat ID). Determines where the reminder message is sent. |
| `description` | `TEXT` | `NOT NULL` | Human-readable task description (e.g., `"Call John"`, `"Stand-up meeting"`). Extracted from the `SCHEDULE:` marker. |
| `due_at` | `TEXT` | `NOT NULL` | ISO 8601 datetime when the task is due (e.g., `"2026-02-17T15:00:00"`). For recurring tasks, this is advanced after each delivery. |
| `repeat` | `TEXT` | nullable | Recurrence pattern. `NULL` means one-shot (same as `"once"`). Valid values: `NULL`, `"daily"`, `"weekly"`, `"monthly"`, `"weekdays"`. |
| `status` | `TEXT` | `NOT NULL`, default `'pending'` | Task lifecycle state. See Status Values below. |
| `created_at` | `TEXT` | `NOT NULL`, default `datetime('now')` | When the task was first created. |
| `delivered_at` | `TEXT` | nullable | When the task was delivered. Set only for one-shot tasks upon completion. Not set for recurring tasks (they remain in `pending` with advanced `due_at`). |

---

### CREATE INDEX: `idx_scheduled_tasks_due`

```sql
CREATE INDEX IF NOT EXISTS idx_scheduled_tasks_due ON scheduled_tasks(status, due_at);
```

| Property | Value |
|----------|-------|
| Columns | `(status, due_at)` |
| Purpose | Efficiently find pending tasks that are due for delivery. Used by `Store::get_due_tasks()` which queries `WHERE status = 'pending' AND datetime(due_at) <= datetime('now')`. |

### CREATE INDEX: `idx_scheduled_tasks_sender`

```sql
CREATE INDEX IF NOT EXISTS idx_scheduled_tasks_sender ON scheduled_tasks(sender_id, status);
```

| Property | Value |
|----------|-------|
| Columns | `(sender_id, status)` |
| Purpose | Efficiently list pending tasks for a specific user. Used by `Store::get_tasks_for_sender()` which queries `WHERE sender_id = ? AND status = 'pending'`. Also supports `Store::cancel_task()`. |

---

## Status Values

| Status | Meaning | Set By |
|--------|---------|--------|
| `pending` | Task is waiting for delivery. This is the initial state and the state for recurring tasks between deliveries. | `create_task()` (default), `complete_task()` (recurring -- keeps status, advances `due_at`) |
| `delivered` | Task has been delivered and is complete. Only applies to one-shot tasks. | `complete_task()` (when `repeat` is `NULL` or `"once"`) |
| `cancelled` | Task was cancelled by the user via `/cancel`. | `cancel_task()` |

---

## Repeat Values

| Value | Meaning | Advance Offset |
|-------|---------|---------------|
| `NULL` | One-shot task (same as `"once"`). Transitions to `'delivered'` after delivery. | N/A |
| `"daily"` | Repeats every day. Task stays `'pending'` with `due_at` advanced. | `+1 day` |
| `"weekly"` | Repeats every 7 days. | `+7 days` |
| `"monthly"` | Repeats every month (same day of month). | `+1 month` |
| `"weekdays"` | Repeats every weekday (Mon-Fri). Skips Saturday and Sunday. | `+1 day` (with weekend skip logic) |

**Weekday skip logic:** After advancing `due_at` by 1 day, if the new date falls on Saturday (`strftime('%w') = 6`), advance by 2 more days to Monday. If it falls on Sunday (`strftime('%w') = 0`), advance by 1 more day to Monday.

---

## Migration Tracking

This migration is registered with name `"005_scheduled_tasks"` in the `_migrations` table. The migration runner in `Store::run_migrations()` checks for this name and skips execution if already applied.

**Migration definitions (compile-time embedded):**
```rust
("005_scheduled_tasks", include_str!("../migrations/005_scheduled_tasks.sql"))
```

---

## Application-Level Usage

### `Store::create_task()`

Creates a new task row with a generated UUID v4.

```rust
pub async fn create_task(
    &self,
    channel: &str,
    sender_id: &str,
    reply_target: &str,
    description: &str,
    due_at: &str,
    repeat: Option<&str>,
) -> Result<String, OmegaError>
```

**Called by:** `gateway.rs::handle_message()` Stage 5b, after extracting a `SCHEDULE:` marker from the provider response.

### `Store::get_due_tasks()`

Finds tasks where `status = 'pending'` and `datetime(due_at) <= datetime('now')`.

```rust
pub async fn get_due_tasks(
    &self,
) -> Result<Vec<(String, String, String, String, Option<String>)>, OmegaError>
```

**Returns:** `(id, channel, reply_target, description, repeat)` tuples.

**Called by:** `gateway.rs::scheduler_loop()` every `poll_interval_secs` seconds.

### `Store::complete_task()`

Marks one-shot tasks as `'delivered'`. For recurring tasks, advances `due_at` by the repeat interval.

```rust
pub async fn complete_task(&self, id: &str, repeat: Option<&str>) -> Result<(), OmegaError>
```

**Called by:** `gateway.rs::scheduler_loop()` after successful message delivery.

### `Store::get_tasks_for_sender()`

Lists pending tasks for a user, ordered by `due_at` ascending.

```rust
pub async fn get_tasks_for_sender(
    &self,
    sender_id: &str,
) -> Result<Vec<(String, String, String, Option<String>)>, OmegaError>
```

**Returns:** `(id, description, due_at, repeat)` tuples.

**Called by:** `commands.rs` for the `/tasks` command.

### `Store::cancel_task()`

Cancels a task by ID prefix, with sender_id ownership check.

```rust
pub async fn cancel_task(&self, id_prefix: &str, sender_id: &str) -> Result<bool, OmegaError>
```

**Called by:** `commands.rs` for the `/cancel` command.

---

## Relationship to Other Migrations

| Migration | Name | What It Creates |
|-----------|------|----------------|
| `001_init.sql` | `001_init` | `conversations`, `messages`, `facts` (original) |
| `002_audit_log.sql` | `002_audit_log` | `audit_log` |
| `003_memory_enhancement.sql` | `003_memory_enhancement` | ALTER `conversations` (+3 cols, +1 idx), DROP+CREATE `facts` |
| `004_fts5_recall.sql` | `004_fts5_recall` | `messages_fts` virtual table, 3 sync triggers, backfill |
| **`005_scheduled_tasks.sql`** | **`005_scheduled_tasks`** | **`scheduled_tasks` table, 2 indexes** |

---

## Idempotency

- `CREATE TABLE IF NOT EXISTS` is idempotent.
- `CREATE INDEX IF NOT EXISTS` is idempotent.
- The entire migration file is idempotent and can safely be re-run, though the migration tracker prevents re-execution.

---

## Performance Considerations

- **Index on (status, due_at):** Optimizes the scheduler's `get_due_tasks()` query, which runs every `poll_interval_secs` seconds. With the index, this is a fast range scan.
- **Index on (sender_id, status):** Optimizes the `/tasks` command and cancellation queries.
- **No triggers:** Unlike the FTS5 migration, this table has no triggers. All state transitions are handled by explicit store method calls.
- **Recurring task storage:** Recurring tasks reuse the same row by advancing `due_at` rather than creating new rows, keeping the table compact.
