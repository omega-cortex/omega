# Full Codebase Audit — 2026-03-01

> Omega AI Agent Infrastructure — Rust Monorepo
> Auditors: 4 parallel reviewer agents (claude-opus-4-6)
> Scope: All 8 milestones, all source files, all specs, all docs

---

## Executive Summary

| Severity | Count | Verdict |
|----------|-------|---------|
| **P0 — Critical** | 6 | REQUIRES IMMEDIATE ACTION |
| **P1 — High** | 10 | Fix before next release |
| **P2 — Medium** | 19 | Scheduled maintenance |
| **P3 — Low** | 12 | Nice to have |
| **Specs/Docs Drift** | 30+ items | Dedicated sync pass needed |

**Overall:** The codebase is well-structured with high code quality (proper error handling, tracing, doc comments, parameterized SQL, UTF-8 safety). However, there are 6 critical findings across security and reliability that need immediate attention, and the specs/docs have accumulated significant drift from the actual implementation.

---

## Critical Findings (P0)

### 1. Marker safety net missing from action task and heartbeat paths
- **Location:** `gateway/scheduler_action.rs`, `gateway/heartbeat_helpers.rs`
- **Issue:** `strip_all_remaining_markers()` is only called in the main pipeline (`process_markers.rs:392`). The action task and heartbeat processing paths skip this safety net. If the AI produces malformed markers, raw protocol text leaks to users via Telegram/WhatsApp.
- **Fix:** Add `strip_all_remaining_markers()` as final step in both `process_action_markers()` and `process_heartbeat_markers()`.

### 2. BUILD_PROPOSAL: marker missing from safety net array
- **Location:** `markers/mod.rs:89-111`
- **Issue:** The `MARKERS` array in `strip_all_remaining_markers()` lists 20 markers but omits `BUILD_PROPOSAL:`. This marker is defined in `protocol.rs` and can leak to users.
- **Fix:** Add `"BUILD_PROPOSAL:"` to the `MARKERS` array.

### 3. Sandbox path checks do not canonicalize symlinks
- **Location:** `omega-sandbox/src/lib.rs:56-126`
- **Issue:** `is_write_blocked()` and `is_read_blocked()` compare paths with `starts_with()` without resolving symlinks. A subprocess could bypass blocklists via symlinks. The OS-level seatbelt catches this on macOS, but HTTP providers on all platforms rely on the code-level check.
- **Fix:** Canonicalize both target and `data_dir` paths before comparison. Default to "blocked" on canonicalization failure (fail-closed).

### 4. Sandbox protects wrong config.toml location
- **Location:** `omega-sandbox/src/lib.rs:120`, `seatbelt.rs:43`
- **Issue:** Sandbox blocks reads to `{data_dir}/config.toml` (i.e., `~/.omega/config.toml`), but the actual `config.toml` with API keys/tokens lives in the CWD where `omega start` runs. The real config is unprotected from subprocess reads.
- **Fix:** Pass the resolved `config_path` to sandbox functions, or block at the `protected_command` level.

### 5. MCP client `request()` has no timeout — potential infinite hang
- **Location:** `omega-providers/src/mcp_client.rs:196-230`
- **Issue:** The `request()` method loops forever reading stdout, waiting for a matching JSON-RPC ID. If the MCP server misbehaves (silent, floods notifications), this never terminates. Can exhaust worker threads over time.
- **Fix:** Wrap in `tokio::time::timeout()` with configurable timeout (e.g., 120s).

### 6. Bash tool timeout does not kill child process
- **Location:** `omega-providers/src/tools.rs:170-206`
- **Issue:** When `exec_bash()` times out, the `tokio::time::timeout` fires but the underlying child process is NOT killed. Orphaned processes accumulate over time.
- **Fix:** Use `tokio::process::Command::kill_on_drop(true)` or manually call `child.kill()` on timeout.

---

## High Findings (P1)

### 7. pipeline.rs: 932 lines — violates 500-line rule by 86%
- **Location:** `gateway/pipeline.rs`
- **Fix:** Split into `pipeline.rs` (message handling) + `prompt_builder.rs` (system prompt composition).

### 8. Hardcoded `"~/.omega"` ignores configurable data_dir
- **Location:** `gateway/scheduler_action.rs:448`
- **Issue:** `process_action_markers()` receives `data_dir` as parameter but uses hardcoded `"~/.omega"`. Breaks custom data directories.
- **Fix:** Use the passed `data_dir` parameter.

### 9. Marker processing logic duplicated across 3 files
- **Location:** `process_markers.rs`, `scheduler_action.rs`, `heartbeat_helpers.rs`
- **Issue:** Same marker extraction/stripping for SCHEDULE, CANCEL_TASK, REWARD, LESSON etc. duplicated in all three. Root cause of P0 #1.
- **Fix:** Extract shared `process_common_markers()` function.

### 10. Heartbeat interval changes not persisted from action/heartbeat paths
- **Location:** `scheduler_action.rs`, `heartbeat_helpers.rs`
- **Issue:** `HEARTBEAT_INTERVAL:` marker in main pipeline persists to config.toml, but action/heartbeat paths only update in-memory AtomicU64. Reverts on restart.
- **Fix:** Pass `config_path` and call `patch_heartbeat_interval()`.

### 11. API token comparison is not constant-time
- **Location:** `api.rs:78`
- **Issue:** `token == key` short-circuits on first differing byte. Enables timing attacks if API is exposed externally.
- **Fix:** Use `subtle::ConstantTimeEq` or double-HMAC comparison.

### 12. `println!` used instead of `tracing` in production code
- **Location:** `init.rs:197-313` (~18 calls), `main.rs:274,367`
- **Fix:** Replace with `tracing::info!()` or `cliclack` styled output.

### 13. Production `unwrap()` in claude_code command.rs
- **Location:** `omega-providers/src/claude_code/command.rs:33`
- **Fix:** Replace with `if let Some(name) = agent_name.filter(|n| !n.is_empty())`.

### 14. 5x `.expect()` in provider constructors (reqwest Client build)
- **Location:** `openai.rs:44`, `anthropic.rs:36`, `ollama.rs:33`, `openrouter.rs:37`, `gemini.rs:35`
- **Fix:** Return `Result<Self, OmegaError>` from `from_config()`.

### 15. WhatsApp `consume_forget_marks` is not transactional
- **Location:** `whatsapp_store/protocol_store.rs:208-223`
- **Issue:** SELECT + DELETE without transaction wrapper. Race condition possible.
- **Fix:** Wrap in `pool.begin()` / `tx.commit()`.

### 16. WhatsApp `sent_ids` HashSet grows unboundedly
- **Location:** `omega-channels/src/whatsapp/mod.rs:32`
- **Issue:** IDs added on send, removed on echo. If echo never arrives, ID persists forever. Slow memory leak over days/weeks.
- **Fix:** Add TTL eviction or cap set size.

---

## Medium Findings (P2)

| # | Issue | Location |
|---|-------|----------|
| 17 | keywords.rs ~773 prod lines (borderline 500-line violation, static data) | `gateway/keywords.rs` |
| 18 | Dead code: `classify_and_route()` + `execute_steps()` (~170 lines with `#[allow(dead_code)]`) | `gateway/routing.rs` |
| 19 | `unwrap()` on `NaiveTime::from_hms_opt(8,0,0)` — use `expect()` or const | `gateway/heartbeat.rs:51`, `markers/helpers.rs:90` |
| 20 | `format_time_ago()` hardcoded in English, ignores `lang` parameter | `commands/learning.rs:64-85` |
| 21 | `language_show()` has hardcoded English "Usage:" text | `i18n/format.rs:22` |
| 22 | Blocking `std::fs::read()` in async context | `gateway/routing.rs:415` |
| 23 | 4 TODO(phase-2) comments without issue tracking | `builds_i18n.rs`, `builds_loop.rs` |
| 24 | No input size limit on webhook request body | `api.rs` |
| 25 | `claudemd.rs` uses `--dangerously-skip-permissions` | `claudemd.rs:164` |
| 26 | init_wizard.rs: world-readable incognito browser script (TOCTOU) | `init_wizard.rs:54-69` |
| 27 | selfcheck.rs does not check WhatsApp channel health | `selfcheck.rs` |
| 28 | selfcheck.rs has zero test coverage | `selfcheck.rs` |
| 29 | provider_builder.rs has zero test coverage | `provider_builder.rs` |
| 30 | pair.rs has zero test coverage | `pair.rs` |
| 31 | Anthropic hardcodes `max_tokens: 8192`, not configurable | `anthropic.rs:190,280` |
| 32 | `mcp_client` and `tools` modules `pub` but should be `pub(crate)` | `omega-providers/src/lib.rs` |
| 33 | Telegram `send_text` silently succeeds on non-Markdown send errors | `telegram/send.rs:29-47` |
| 34 | No tests for WhatsApp `events.rs` message handling | `whatsapp/events.rs` |
| 35 | `context.rs` at 468 lines — approaching 500-line limit | `omega-memory/src/store/context.rs` |

---

## Low Findings (P3)

| # | Issue | Location |
|---|-------|----------|
| 36 | `split_message` duplicated identically in Telegram and WhatsApp send modules | `telegram/send.rs`, `whatsapp/send.rs` |
| 37 | WhatsApp creates new `reqwest::Client` per voice message | `whatsapp/events.rs:127` |
| 38 | Dead code: `bootstrapped` variable computed then suppressed | `omega-memory/src/store/context.rs:138,152` |
| 39 | `#[allow(dead_code)]` on Telegram types masks genuinely unused fields | `telegram/types.rs` |
| 40 | `thiserror` and `anyhow` deps declared but unused | `omega-channels/Cargo.toml`, `omega-memory/Cargo.toml` |
| 41 | WhatsApp store schema init: 13 CREATE TABLE statements without transaction | `whatsapp_store/mod.rs:28-167` |
| 42 | `service.rs` hardcoded fallback paths (`/Users/unknown`, `/home/unknown`) | `service.rs:30,79` |
| 43 | Missing spec files for `provider_builder.rs` and `pair.rs` | `specs/` |
| 44 | CLAUDE.md stale: Gemini auth still says "URL query param" | `CLAUDE.md:202` |
| 45 | Test name drift between specs and code (6 mismatched names) | Multiple provider specs |
| 46 | Agentic loops clone entire message history each turn | Multiple provider files |
| 47 | No integration tests for agentic loops (only unit tests for serde) | `omega-providers` |

---

## Line Count Violations

| File | Production Lines | Status |
|------|-----------------|--------|
| `gateway/pipeline.rs` | 932 | **VIOLATION** (500 max) |
| `gateway/keywords.rs` | ~773 | **VIOLATION** (borderline, static data) |
| `gateway/scheduler_action.rs` | 505 | **BORDERLINE** (just over) |
| `omega-memory/src/store/context.rs` | 468 | NEAR LIMIT |
| All other files | <500 | OK |

---

## Specs/Docs Drift — Consolidated

### Missing Specs
- `specs/src-provider-builder-rs.md` — no spec for `provider_builder.rs`
- `specs/src-pair-rs.md` — no spec for `pair.rs`
- `specs/memory-migration-008.md` — no spec for migration `008_user_aliases.sql`
- `specs/src-i18n-rs.md` — no spec for `i18n/` module (if expected)

### Missing Docs
- `docs/providers-gemini.md`
- `docs/providers-tools.md`
- `docs/providers-mcp-client.md`
- `docs/memory-migration-008.md`
- `docs/memory-migration-012.md`

### Critical Spec Drift
| Spec | Issue |
|------|-------|
| `core-config.md` | WhatsAppConfig fields completely wrong (bridge_url/phone_number vs allowed_users/whisper_api_key) |
| `core-config.md` | `default_max_turns()` says 10, actual is 25 |
| `core-config.md` | `default_allowed_tools()` says 4 tools, actual is empty vec |
| `core-config.md` | Missing `api: ApiConfig` field in Config struct hierarchy |
| `core-config.md` | Missing Telegram `whisper_api_key` field |
| `core-config.md` | `default_name()` says "Omega", actual is "OMEGA Ω" |
| `core-config.md` | Missing 5 prompt sections (builds, summarize, facts, heartbeat, heartbeat_checklist) |
| `channels-telegram.md` | References single file, actual is directory module with 5 files |
| `channels-whatsapp.md` | References single files, actual are directory modules |
| `channels-lib.md` | Missing whatsapp, whatsapp_store, whisper modules; missing send_photo, as_any() |
| `memory-store.md` | References single file, actual is 7 submodules; many missing function signatures and parameters |
| `memory-audit.md` | Says no derived traits but code derives Clone; mentions UTF-8 panic risk that's been fixed |
| `skills-lib.md` | Lists 3 bundled skills, code has 5; missing Project.skills field |
| `providers-claude-code.md` | max_turns default 10 vs actual 25; wrong fallback text |
| `providers-tools.md` | Says no read sandbox restriction but code enforces is_read_blocked() |
| `providers-cargo-toml.md` | Missing omega-sandbox dependency |
| `src-main-rs.md` | Non-existent `--sandbox` CLI option; missing WhatsApp in startup flow |
| `src-gateway-rs.md` | Missing `heartbeat_notify` field; normalizes pipeline.rs 500-line violation |
| `src-commands-rs.md` | Documents `/wa` alias that isn't implemented |

---

## Positive Observations

- Zero `unwrap()` in production code across omega-channels, omega-memory, omega-skills
- Zero `unsafe` outside the two documented exceptions (libc::geteuid, landlock pre_exec)
- Zero TODO/FIXME/HACK in library crates
- All SQL queries use parameterized binds — no SQL injection vectors
- FTS5 search input properly sanitized
- UTF-8 boundary handling with `floor_char_boundary` prevents panics
- Auth enforced per-channel before processing messages
- Group messages dropped at channel level
- Comprehensive test coverage: ~3,500+ lines of tests across the workspace

---

## Recommended Priority

### Immediate (this sprint)
1. P0 #1-2: Add marker safety net to action/heartbeat paths + add BUILD_PROPOSAL to array
2. P0 #5-6: Add MCP client timeout + kill_on_drop for bash tool
3. P0 #3-4: Fix sandbox symlink bypass + protect actual config.toml location
4. P1 #8: Fix hardcoded `~/.omega` in scheduler_action.rs
5. P1 #10: Persist heartbeat interval from all paths

### Next release
6. P1 #7: Split pipeline.rs (932 lines)
7. P1 #9: Extract shared marker processing function
8. P1 #13: Fix unwrap() in command.rs
9. P2 #20-21: i18n completeness (hardcoded English strings)

### Maintenance backlog
10. P2 items: Missing tests, dead code cleanup, async blocking call
11. P3 items: Code dedup, unused deps, test name sync

### Dedicated pass
12. Specs/docs sync: 30+ drift items require a focused reconciliation pass

---

*Report generated by 4 parallel reviewer agents. Each milestone reviewed independently to avoid context contamination.*
