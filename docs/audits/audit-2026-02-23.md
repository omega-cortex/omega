# Omega Full Audit Report -- 2026-02-23

## Executive Summary

**Overall status: REQUIRES ITERATION**

The Omega codebase is well-structured for a Rust project of this scope. The modular architecture (6 crates + binary), async-everywhere design, parameterized SQL queries, and comprehensive test coverage for the memory layer are strong positives. However, this audit uncovered:

- **4 production-crashing UTF-8 byte-slicing panics** across providers, memory, and channels
- **No HTTP timeouts** on all 5 HTTP-based provider clients
- **Severe specs/docs drift** with 6 broken SPECS.md links, 10 missing DOCS.md files, and stale struct/function signatures
- **FTS5 query syntax injection** in message search
- **API key exposure risk** in Gemini provider

The specs and docs have accumulated significant drift across multiple refactoring passes. The master index files (SPECS.md and DOCS.md) are the most critical documentation failures.

---

# Part 1: Code Audit

## Critical Findings

### 1. UTF-8 Byte-Slicing Panic (4 locations)

All four occurrences use byte-index slicing (`&s[..n]` or `&s[start..end]`) where `n`/`start`/`end` are computed from `s.len()` (byte length), not character boundaries. With 8-language i18n support (including Russian/Cyrillic), multi-byte characters are guaranteed. Slicing at a byte position inside a multi-byte sequence **panics at runtime**.

**Location A:** `crates/omega-providers/src/tools.rs:352-361`

```rust
fn truncate_output(s: &str, max_chars: usize) -> String {
    if s.len() <= max_chars {
        s.to_string()
    } else {
        let truncated = &s[..max_chars]; // PANIC: byte index, not char boundary
        // ...
    }
}
```

**Severity:** Critical -- processes tool output from bash commands, file reads, and MCP tools. Any tool returning multi-byte content near the truncation boundary will crash the agentic tool loop.

**Location B:** `crates/omega-memory/src/audit.rs:87-93`

```rust
fn truncate(s: &str, max: usize) -> &str {
    if s.len() <= max { s } else { &s[..max] } // PANIC
}
```

**Severity:** Critical -- truncates audit log entries. Any user message with multi-byte characters near the 80-byte boundary will panic during audit logging, which runs on every message.

**Location C:** `crates/omega-memory/src/store/context.rs:332`

```rust
let truncated = if content.len() > 200 {
    format!("{}...", &content[..200]) // PANIC
} else { content.clone() };
```

**Severity:** Critical -- truncates recalled FTS5 search results during context building.

**Location D:** `crates/omega-channels/src/telegram/send.rs:160-170`

```rust
let end = (start + max_len).min(text.len()); // byte arithmetic
let break_at = if end < text.len() {
    text[start..end] // PANIC: end may not be a char boundary
        .rfind('\n')
        .map(|i| start + i + 1)
        .unwrap_or(end)
} else { end };
```

**Severity:** Critical -- splits long Telegram messages. Any response with multi-byte characters at a splitting boundary will panic during delivery.

**Fix:** Use `s.floor_char_boundary(n)` (stable since Rust 1.82) or `s.char_indices()`:

```rust
fn truncate_output(s: &str, max_bytes: usize) -> String {
    if s.len() <= max_bytes { return s.to_string(); }
    let boundary = s.floor_char_boundary(max_bytes);
    format!("{}\n\n... (output truncated)", &s[..boundary])
}
```

---

### 2. No HTTP Timeout on Provider Clients

**Locations:**
- `crates/omega-providers/src/openai.rs:41` -- `reqwest::Client::new()`
- `crates/omega-providers/src/ollama.rs:30` -- `reqwest::Client::new()`
- `crates/omega-providers/src/anthropic.rs:33` -- `reqwest::Client::new()`
- `crates/omega-providers/src/openrouter.rs:34` -- `reqwest::Client::new()`
- `crates/omega-providers/src/gemini.rs:32` -- `reqwest::Client::new()`

**Severity:** Critical -- `reqwest::Client::new()` has no default timeout. If a provider API hangs, the request blocks the tokio task indefinitely. During the agentic tool loop (up to 64 turns), a single hung request makes the bot unresponsive. The Claude Code provider correctly uses `tokio::time::timeout`, but HTTP providers do not.

**Fix:** `reqwest::Client::builder().timeout(Duration::from_secs(120)).build().unwrap()` or a configurable timeout per provider.

---

### 3. FTS5 Query Syntax Injection

**Location:** `crates/omega-memory/src/store/messages.rs:66-77`

```rust
WHERE messages_fts MATCH ?
// query is bound directly -- no FTS5 operator escaping
```

**Severity:** High -- While parameterized binding prevents SQL injection, FTS5 has its own syntax. User messages containing `AND`, `OR`, `NOT`, `NEAR`, `*`, `"`, or parentheses cause FTS5 parse errors or unexpected query behavior.

**Fix:** Escape/quote the query: `format!("\"{}\"", query.replace('"', "\"\""))` or strip FTS5 operators.

---

## High Findings

### 4. Gemini API Key in URL Query Parameter

**Location:** `crates/omega-providers/src/gemini.rs:210-213`

```rust
let url = format!(
    "{GEMINI_BASE_URL}/models/{effective_model}:generateContent?key={}",
    self.api_key
);
```

**Severity:** High -- API key in URL query string. Any reqwest error, proxy log, or HTTP access log that captures the full URL exposes the key.

**Fix:** Use `x-goog-api-key` HTTP header instead (Gemini API supports both).

---

### 5. SYSTEM_FACT_KEYS Triplicated -- Drift Risk

**Locations** (identical `["welcomed", "preferred_language", "active_project", "personality", "onboarding_stage"]`):
- `src/gateway/keywords.rs:164`
- `src/commands/tasks.rs:78`
- `crates/omega-memory/src/store/context.rs:12`

**Severity:** High -- If any copy is updated without the others, the system has inconsistent fact filtering behavior. A maintenance time bomb.

**Fix:** Define `SYSTEM_FACT_KEYS` once in `omega-core` and import everywhere.

---

### 6. Production `unwrap()` in Gateway Dispatch

**Location:** `src/gateway/mod.rs:290`

```rust
if active.contains_key(&sender_key) {
    active.get_mut(&sender_key).unwrap().push(incoming.clone());
```

**Severity:** Medium -- Guarded by `contains_key` above and lock is held, but violates the project's explicit "No `unwrap()`" rule. Becomes a panic if code is ever refactored to release the lock.

**Fix:** Use `if let Some(buf) = active.get_mut(&sender_key)` or entry API.

---

## Minor Findings

### 7. Dead Code with `#[allow(dead_code)]`

**Location:** `src/gateway/routing.rs`
- Line 19: `classify_and_route()` -- marked dead
- Line 64: `execute_steps()` -- marked dead

~150 lines of unreachable code each. Either re-enable, remove, or move behind a feature flag.

### 8. `#[allow(clippy::too_many_arguments)]` Usage

Multiple functions with 7-8+ parameters suggest struct encapsulation opportunities:
- `crates/omega-memory/src/store/tasks.rs:11` (`create_task` -- 8 params)
- Several gateway functions

### 9. Weekday Skip: Two Separate UPDATE Queries

**Location:** `crates/omega-memory/src/store/tasks.rs:153-173`

Two DB round-trips for Saturday/Sunday skip where one CASE expression would suffice. Functionally correct but inefficient.

### 10. Quadratic Word Comparison in `descriptions_are_similar`

O(n*m) word overlap counting. Harmless for typical task descriptions but lacks length guard.

---

# Part 2: Specs/Docs Drift Audit

## Critical Findings

### 11. Gateway Spec Contains Phantom Field `cli_sessions`

- **Spec:** `specs/src-gateway-rs.md` (lines 67, 87)
- **Code:** `src/gateway/mod.rs` -- field does not exist (removed in migration 012)
- **Internal contradiction:** `specs/memory-migration-012.md` line 126 correctly states it was removed, but gateway spec was never updated
- **Impact:** A developer relying on the spec would write code against a nonexistent field

### 12. Gateway Spec Missing 4 Fields That Exist in Code

- **Spec:** `specs/src-gateway-rs.md` (lines 50-68)
- **Missing:** `api_config: ApiConfig`, `data_dir: String`, `skills: Vec<omega_skills::Skill>`, `config_path: String`
- **Impact:** Impossible to construct a Gateway using the spec's `new()` signature

### 13. SPECS.md Index Has 4 Broken Links + 2 Phantom Links

**Broken links (wrong names):**
| Index Says | Actual File |
|-----------|-------------|
| `binary-main.md` | `src-main-rs.md` |
| `binary-commands.md` | `src-commands-rs.md` |
| `binary-selfcheck.md` | `src-selfcheck-rs.md` |
| `binary-service.md` | `src-service-rs.md` |

**Phantom links (files don't exist):**
- `workspace.md` (line 12)
- `memory-migrations.md` (line 56)

### 14. DOCS.md Index Has 10 Links to Nonexistent Files

Missing files: `quickstart.md`, `configuration.md`, `security.md`, `channels.md`, `memory.md`, `memory-migration-012.md`, `operations.md`, `service.md`, `commands.md`, `development.md`

Over a third of the documentation index is broken.

### 15. `build_provider()` Spec Is Wrong on 3 Axes

**Spec:** `specs/src-main-rs.md` (line 107)

| Aspect | Spec Says | Code Actually |
|--------|-----------|---------------|
| Location | `main.rs` | `src/provider_builder.rs` |
| Parameter | `workspace_path: Option<PathBuf>` | `workspace_path: &std::path::Path` |
| Return type | `Result<Box<dyn Provider>>` | `Result<(Box<dyn Provider>, String, String)>` |

---

## High-Severity Findings

### 16. `Context` Struct Spec Missing 2 Fields

- **Spec:** `specs/core-context.md` (lines 52-70)
- **Missing:** `max_turns: Option<u32>`, `allowed_tools: Option<Vec<String>>`

### 17. `ApiConfig` Completely Absent from Config Spec

- **Spec:** `specs/core-config.md`
- **Code:** `crates/omega-core/src/config/mod.rs` (lines 147-168)
- An entire config section (`ApiConfig` with `enabled`, `host`, `port`, `api_key`) is undocumented

### 18. `find_all_active_conversations` Return Type Drift

- **Spec:** `Vec<(String, String, String)>` (3-tuple)
- **Code:** `Vec<(String, String, String, String)>` (4-tuple -- project column added by migration 012)

### 19. Commands Spec Enum Missing 4 Variants

- **Missing:** `Personality`, `Skills`, `Purge`, `WhatsApp`

### 20. 5 Module Paths Wrong Due to Refactoring

| Spec File | Spec Says | Actual Path |
|-----------|-----------|-------------|
| `specs/core-config.md` | `config.rs` | `config/` (6 files) |
| `specs/memory-store.md` | `store.rs` | `store/` (9 files) |
| `specs/src-markers-rs.md` | `src/markers.rs` | `src/markers/` (7 files) |
| `specs/src-commands-rs.md` | `src/commands.rs` | `src/commands/` (6 files) |
| `specs/providers-claude-code.md` | `claude_code.rs` | `claude_code/` (6 files) |

---

## Medium-Severity Findings

### 21. CONVERSATION_TIMEOUT_MINUTES: Code = 120, Specs/Docs = 30

6 spec/doc files still say 30 minutes:

| File | Location |
|------|----------|
| `specs/memory-store.md` | lines 21, 453 |
| `specs/memory-lib.md` | line 73 |
| `docs/memory-store.md` | lines 132-143, 168, 586 |
| `docs/memory-lib.md` | line 93 |
| `docs/memory-migration-003.md` | lines 51, 62, 207 |
| `docs/readme-md.md` | line 86 |

### 22. SPECS.md Missing 17+ Existing Spec Files from Index

Including: `cargo-toml-root.md`, `license.md`, `readme-md.md`, `cargo-lock.md`, `core-cargo-toml.md`, `memory-migration-001.md` through `003.md`, and more.

### 23. DOCS.md Missing 38 Existing Doc Files from Index

38 doc files exist on disk but are not referenced in DOCS.md.

### 24. `docs/src-gateway-rs.md` Says "9 Files", Actual Is 12

Missing from doc: `scheduler_action.rs`, `heartbeat_helpers.rs`, `tests.rs`

### 25. Module Visibility Drift in `providers-lib.md`

Spec says `mcp_client` and `tools` are `pub(crate) mod`; actual code is `pub mod`.

### 26. `core-lib.md` Claims "No Re-exports"

Code has `pub use config::shellexpand;`

### 27. `memory-lib.md` Says 2 Re-exports, Code Has 3

Missing: `pub use store::detect_language;`

### 28. Migration 008 (User Aliases) Has No Spec or Doc

---

## Low-Severity Findings

### 29. No Spec for `src/provider_builder.rs`
### 30. No Spec for `src/pair.rs`
### 31. No Spec for `src/i18n/` Module (6 files, 450+ lines)
### 32. CLAUDE.md Security -- config.toml is read-blocked only, not write-blocked as implied
### 33. `docs/architecture.md` Says "7 crates" vs CLAUDE.md "6 crates"

---

# Part 3: Prioritized Action Plan

## P0 -- Fix Before Next Release

| # | Issue | Files to Change |
|---|-------|----------------|
| 1 | Fix UTF-8 byte-slicing panics (4 locations) | `tools.rs`, `audit.rs`, `context.rs`, `send.rs` |
| 2 | Add HTTP timeouts to all 5 provider clients | `openai.rs`, `ollama.rs`, `anthropic.rs`, `openrouter.rs`, `gemini.rs` |
| 3 | Sanitize FTS5 query input | `messages.rs` |

## P1 -- Address Soon

| # | Issue | Files to Change |
|---|-------|----------------|
| 4 | Move Gemini API key to HTTP header | `gemini.rs` |
| 5 | Centralize `SYSTEM_FACT_KEYS` in omega-core | `keywords.rs`, `tasks.rs`, `context.rs`, new `omega-core` const |
| 6 | Replace `unwrap()` in gateway dispatch | `mod.rs` |
| 7 | Fix 6 broken SPECS.md index links | `specs/SPECS.md` |
| 8 | Fix or create 10 missing DOCS.md entries | `docs/DOCS.md` + new files |
| 9 | Update gateway spec (remove `cli_sessions`, add 4 missing fields) | `specs/src-gateway-rs.md` |
| 10 | Fix `build_provider()` spec | `specs/src-main-rs.md` or new spec |

## P2 -- Technical Debt

| # | Issue |
|---|-------|
| 11 | Update 5 specs for directory module refactoring |
| 12 | Update CONVERSATION_TIMEOUT_MINUTES in 6 spec/doc files |
| 13 | Add 17+ missing specs to SPECS.md index |
| 14 | Add 38 missing docs to DOCS.md index |
| 15 | Update Context struct spec (2 missing fields) |
| 16 | Document ApiConfig in config spec |
| 17 | Update commands spec (4 missing enum variants) |
| 18 | Update gateway doc (9 files -> 12 files) |
| 19 | Create spec for `src/i18n/` module |
| 20 | Remove or feature-flag dead code in `routing.rs` |

---

# Appendix: Statistics

| Metric | Count |
|--------|-------|
| Total critical code findings | 3 (UTF-8 panics, HTTP timeouts, FTS5 injection) |
| Total high code findings | 3 (Gemini key, SYSTEM_FACT_KEYS, unwrap) |
| Total specs/docs critical drift | 5 (phantom fields, broken indexes, wrong signatures) |
| Total specs/docs high drift | 5 (missing structs, wrong return types, wrong paths) |
| Total specs/docs medium drift | 8 |
| Broken SPECS.md links | 6 |
| Broken DOCS.md links | 10 |
| Orphaned spec files (not in index) | 17+ |
| Orphaned doc files (not in index) | 38 |
| Files needing UTF-8 fix | 4 |
| Providers needing timeout | 5 |
| Spec/doc files with wrong timeout constant | 6 |
